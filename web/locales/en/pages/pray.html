<!-- Copyright 2025 (AGPL-3.0-or-later), Miles K. Bertrand et al. -->

<script type="text/javascript" src="/resources/js/ritegen.js?v=11"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/resources/js/exsurge.js"></script>
<script type="text/javascript" src="/resources/js/gabc-chant.js"></script>
<div id="content-container-outer" x-data="{
	list: [],
	optionspanel: false,
	date: new Date(),
	time: 'diurnale',
	day: '',
	color: '',
	hour: '',
	choral: $persist(true),
	chant: $persist(false),
	recitation: $persist('recto-tono'),
	translation: $persist(false),
	desired: $persist('omnes'),
	ambit: $persist([]),
	rite: '',
	initialized: false,
	dayinitialized: false,
	get Rite() {
		return this.rite;
	},
	setDate(date) {
		this.date = new Date(new Date(date + new Date().toISOString().substring(10)).getTime() + this.date.getTimezoneOffset() * 60000);
	},
	realDate() {
		return new Date(this.date.getTime() - this.date.getTimezoneOffset() * 60000);
	},
	setRecitation(recitation) {
		if (recitation == 'plainchant') {
			this.choral = true;
			this.chant = true;
		} else if (recitation == 'recto-tono') {
			this.choral = true;
			this.chant = false;
		} else if (recitation == 'private') {
			this.choral = false;
			this.chant = false;
		}
		this.ambit = defineambit(this.desired, this.choral);
		this.list = ritelist(this.day.tags, this.ambit);
		this.slideHour(this.hour.id);
		this.recitation = recitation;
	},
	updateRiteAsyncLock: false,
	async updateRite() {
		window.scrollTo({top:0});
		lasttitle = '';
		if (!this.updateRiteAsyncLock) {
			this.updateRiteAsyncLock = true;
			for (var i = 0; i < this.hour.content.length; i++) {
				select = this.hour.content[i][1] == 'diei' ? '' : this.hour.content[i][1];
				noending = false;
				if (i != this.hour.content.length - 1 && (this.hour.content[i + 1][1] == 'officium-parvum-bmv' || this.hour.content[i + 1][1] == 'officium-defunctorum' || this.hour.content[i + 1][0] == 'psalmi-poenitentiales')) {
					noending = true;
				}
				var response = await fetch(`/rite?date=${this.realDate().toISOString().substring(0, 10)}&time=${this.time}&hour=${this.hour.content[i][0]}&noending=${noending}&translation=${this.translation ? translation(locale) : 'none'}&privata=${this.recitation=='private' ? 'privata': 'chorali'}` + (select == '' ? '' : `&select=${select}`));
				var json = await response.json();
				// If this is the first item in the updated rite, wipe the slate clean. Otherwise just append.
				if (i == 0) {
					title = riteTitle(json, 'large')
					this.rite = title + render(json, this.chant);
					lasttitle = json.usednames[0];
				} else {
					title = '';
					if (json.usednames[0] != lasttitle) {
						title = riteTitle(json, 'small');
					}
					this.rite += title + render(json, this.chant);
					lasttitle = json.usednames[0];
				}
			}
			this.initialized = true;
			this.updateRiteAsyncLock = false;
		} else {
			console.log('Simultaneous attempts to update Rite');
		}
	},
	slideHour(id) {
		for (var i = 0; i < this.list.length; i++) {
			if (this.list[i].id == id) {
				this.hour = this.list[i];
				return;
			}
		}
	},
	async updateDay() {
		const colors = ['violacei', 'rubri', 'viridis', 'aurei'];

		var response = await fetch(`/day?date=${this.realDate().toISOString().substring(0, 10)}&time=${this.time}`);
		var json = await response.json();
		var primary = json.primary[1];
		this.color = primary.filter((tag) => colors.includes(tag))[0];
		this.list = ritelist(json.tags, this.ambit);
		this.day = json;
		if (this.dayinitialized) {
			this.slideHour(this.hour.id);
			this.updateRite();
		}
		this.dayinitialized = true;
	},
	setTime(time) {
		this.time = time;
		this.updateDay();
	},
	setHour(id) {
		this.slideHour(id);
		oldtime = this.time;
		newtime = (this.hour.id == 'vesperae' || this.hour.id == 'completorium') ? 'vesperale' : 'diurnale';
		if (newtime != oldtime) {
			this.setTime(newtime);
		} else {
			this.updateRite();
		}


	},
	setAmbit(ambit) {
		oldambit = this.ambit;
		this.ambit = ambit;
		this.list = ritelist(this.day.tags, this.ambit);

		if (this.ambit.length < oldambit.length && this.ambit.length == 1) {
			this.setHour('matutinum');
		} else if (this.ambit.length < oldambit.length && this.ambit.length == 2) {
			if (this.hour.id == 'completorium') {
				this.setHour('vesperae');
			} else if (['prima', 'tertia', 'sexta', 'nona'].includes(this.hour.id)) {
				this.setHour('matutinum');
			} else {
				this.slideHour(this.hour.id);
				this.updateRite();
			}
		} else {
			this.slideHour(this.hour.id);
			this.updateRite();
		}
	}
}" x-init="
  	if (ambit == '') {
		ambit = defineambit(desired, choral);
	}
	$watch('date', date => updateDay());
	$watch('desired', desired => setAmbit(defineambit(desired, choral)));
	$watch('recitation', recitation => updateRite());
	$watch('translation', translation => updateRite());
	$watch('dayinitialized', dayinitialized => {
		if (list.length == 7) {
			if (date.getHours() < 6) {
				hour = list[0];
			} else if (date.getHours() < 9) {
				hour = list[1];
			} else if (date.getHours() < 11) {
				hour = list[2];
			} else if (date.getHours() < 14) {
				hour = list[3];
			} else if (date.getHours() < 16) {
				hour = list[4];
			} else if (date.getHours() < 20) {
				hour = list[5];
			} else {
				hour = list[6];
			}
		} else if (list.length == 2) {
			if (date.getHours() < 16) {
				hour = list[0];
			} else {
				hour = list[1];
			}
		} else if (list.length == 1) {
			hour = list[0];
		}
		updateRite();
	});
	if (date.getHours() >= 16) {
		time = 'vesperale';
	}
	updateDay();
">
	<div x-cloak id="options-panel-background" x-show="optionspanel">
		<div id="options-panel" x-trap.noscroll="optionspanel" @click.outside="optionspanel = false">
			<h3 id="options-panel-title">Options</h3>
			<button class="options-panel-button" @click="translation = !translation" :class="translation? 'options-panel-button-on' : 'options-panel-button-off'">Translation</button>
			<div class="recitation-select-container">
				<button class="options-panel-button recitation-select-button" @click="setRecitation('plainchant');" :class="recitation == 'plainchant'? 'options-panel-button-on' : 'options-panel-button-off'">Plainchant</button>
				<button class="options-panel-button recitation-select-button" @click="setRecitation('recto-tono');" :class="recitation == 'recto-tono'? 'options-panel-button-on' : 'options-panel-button-off'">Recto Tono</button>
				<button class="options-panel-button recitation-select-button" @click="setRecitation('private');" :class="recitation == 'private'? 'options-panel-button-on' : 'options-panel-button-off'">Private</button>
			</div>
			<template x-if="initialized">
				<div id="options-panel-require-initialized-container">
					<div id="coincidences-list-container">
						<h3 class="options-panel-section-head">Coincidences</h3>
						<h4 class="coincidences-label">Primary</h4>
						<div id="primary-entry" class="coincidence-entry" x-text="abbreviateName(day.primary[0])"></div>
						<h4 class="coincidences-label">Commemorations</h4>
						<template x-for="commemoration in day.commemorations">
							<div class="coincidence-entry" x-text="abbreviateName(commemoration[0])"></div>
						</template>
						<h4 class="coincidences-label">Omissions</h4>
						<template x-for="omission in day.omissions">
							<div class="coincidence-entry" x-text="abbreviateName(omission[0])"></div>
						</template>
						<h4 class="coincidences-label">Votives</h3>
					</div>
					<div id="ambit-select-wrapper">
					<div id="ambit-select-container" x-data="{ambitEntries: [['omnes', 'Officium'], ['diei', 'Officium diei'], ['officium-parvum-bmv', 'Officium Parvum B.M.V.'], ['officium-defunctorum', 'Officium Defunctorum'], ['psalmi-graduales', 'Psalmi Graduales'], ['psalmi-poenitentiales', 'Psalmi PÅ“nitentiales']]}">
						<h3 class="options-panel-section-head">Selection</h3>
						<template x-for="entry in ambitEntries">
							<button class="options-panel-button" :class="desired == entry[0] ? 'options-panel-button-on' : 'options-panel-button-off'" x-text="entry[1]" @click="desired = entry[0]"></button>
						</template>
					</div>
					</div>
				</div>
			</template>
		</div>
	</div>
	<div id="side-panel-left" :class="color">
	</div>
	<div id="rite-page-container">
		<div x-show="initialized" id="rite-container" x-html="Rite">
		</div>
		<div id="bottom-easy-select-container" x-data="{open: true}">
			<button id="bottom-easy-select-hide" @click="open = !open"><img id="bottom-easy-select-hide-icon" :class="!open && 'bottom-easy-select-hide-icon-closed'" src="/resources/svg/down.svg" /></button>
			<div id="bottom-easy-select-content-container" x-show="open" x-transition>
				<div id="date-selector-container" x-data="{search: ''}">
					<button id="date-selector-decrement" class="date-selector-button" @click="date = new Date(date.getTime() - 86400000); search = realDate().toISOString().substring(0,10)">&#8592;</button>
					<input id="date-selector-text" type="date" x-model="search" x-init="search = realDate().toISOString().substring(0,10)" @keyup.enter.window="setDate(search);">
					<button id="date-selector-text-submit" class="date-selector-button" @click="setDate(search);">&#8629;</button>
					<button id="date-selector-increment" class="date-selector-button" @click="date = new Date(date.getTime() + 86400000); search = realDate().toISOString().substring(0,10)">&#8594;</button>
					<button id="options-button" @click="optionspanel = !optionspanel">Options</button>
				</div>
				<div id="rite-selector-container">
					<template x-for="item in list">
						<button class="rite-selector-button" :class="(item.id == hour.id) && 'rite-selector-button-selected'" @click="setHour(item.id)" x-text="item.name"></button>
					</template>
				</div>
			</div>
		</div>
	</div>
	<div id="side-panel-right" :class="color">
	</div>
</div>
