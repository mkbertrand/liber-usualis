<!-- Copyright 2024 (AGPL-3.0-or-later), Miles K. Bertrand et al. -->

<script type="text/javascript" src="/resources/js/ritegen.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/resources/js/exsurge.js"></script>
<script type="text/javascript" src="/resources/js/gabc-chant.js"></script>
<div id="content-container-outer" x-data="{
	optionspanel: false,
	date: new Date(),
	day: '',
	color: '',
	hour: '',
	chant: false,
	translation: false,
	rite: '',
	initialized: false,
	get Rite() {
		return this.rite;
	},
	setDate(date) {
		this.date = new Date(new Date(date + new Date().toISOString().substring(10)).getTime() + this.date.getTimezoneOffset() * 60000);
	},
	realDate() {
		return new Date(this.date.getTime() - this.date.getTimezoneOffset() * 60000);
	},
	async update() {
		this.chant;
		const colors = ['violacei', 'rubri', 'viridis', 'aurei'];
		var response = await fetch('/rite?date=' + this.realDate().toISOString().substring(0, 10) + '&hour=' + this.hour + '&translation=' + this.translation);
		var json = await response.json();
		this.rite = render(json, this.chant);
		this.initialized = true;

		var primary = json.day.filter((tags) => tags.includes('primarium'))[0];
		this.color = primary.filter((tag) => colors.includes(tag))[0];
	}
}" x-init="
	if (date.getHours() < 6) {
		hour = 'matutinum+laudes';
	} else if (date.getHours() < 9) {
		hour = 'prima';
	} else if (date.getHours() < 11) {
		hour = 'tertia';
	} else if (date.getHours() < 14) {
		hour = 'sexta';
	} else if (date.getHours() < 16) {
		hour = 'nona';
	} else if (date.getHours() < 20) {
		hour = 'vesperae';
	} else {
		hour = 'completorium';
	}
" x-effect="update()">
	<div x-cloak id="options-panel-background" x-show="optionspanel">
		<div id="options-panel" x-trap.noscroll="optionspanel" @click.outside="optionspanel = false">
			<div id="options-panel-title">Options</div>
			<button class="options-panel-button" @click="translation = !translation">Translation toggle</button>
			<button class="options-panel-button" @click="chant = !chant">Chant toggle</button>
		</div>
	</div>
	<div id="side-panel-left" :class="color">
	</div>
	<div id="rite-page-container">
		<div x-show="initialized" id="rite-container" x-html="Rite">
		</div>
		<div id="bottom-easy-select-container" x-data="{open: true}">
			<button id="bottom-easy-select-hide" @click="open = !open"><img id="bottom-easy-select-hide-icon" src="/resources/svg/down.svg" /></button>
			<div id="bottom-easy-select-content-container" x-show="open" x-transition>
				<div id="date-selector-container" x-data="{search: ''}">
					<button id="date-selector-decrement" class="date-selector-button" @click="date = new Date(date.getTime() - 86400000); search = realDate().toISOString().substring(0,10)">&#8592;</button>
					<input id="date-selector-text" type="date" x-model="search" x-init="search = realDate().toISOString().substring(0,10)" @keyup.enter.window="setDate(search);">
					<button id="date-selector-text-submit" class="date-selector-button" @click="setDate(search);">&#8629;</button>
					<button id="date-selector-increment" class="date-selector-button" @click="date = new Date(date.getTime() + 86400000); search = realDate().toISOString().substring(0,10)">&#8594;</button>
					<button id="options-button" @click="optionspanel = !optionspanel">Options</button>
				</div>
				<div id="rite-selector-container" x-data="{
					 rites: [{'id': 'matutinum+laudes', 'name':'Matutinum &amp; Laudes'}, {'id': 'prima', 'name': 'Prima'}, {'id': 'tertia', 'name': 'Tertia'}, {'id': 'sexta', 'name': 'Sexta'}, {'id': 'nona', 'name': 'Nona'}, {'id': 'vesperae', 'name': 'Vesperae'}, {'id': 'completorium', 'name': 'Completorium'}]
					 }">
					<template x-for="rite in rites">
						<button class="rite-selector-button" :class="(rite.id == hour) && 'rite-selector-button-selected'" @click="hour = rite.id" x-text="rite.name"></button>
					</template>
				</div>
			</div>
		</div>
	</div>
	<div id="side-panel-right" :class="color">
	</div>
</div>
